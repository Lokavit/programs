# START 2021.02.20
- 旧版所有模块代码全部移动到`_old`目录下。
- 在支付宝管理中心恢复设备，可将设备中程序清除;
- 下载IDE=》创建IOTDEMO小程序=》设置小程序=》选择设备号=》调试=》推送。
- .axml .acss .js  .json(一些配置，如子页面路由，标题等)
- 因控制台输出`framework`干扰，所有数据监测使用warning
- setStorageSync：key使用驼峰，data:{}中若对象形式，使用全大写_连接符
- getStorageSync：取值接收的变量使用const 全大写_连接符
- reLaunch: 关闭当前所有页面，跳转到应用内的某个指定页面(房子)
- navigateTo: 从当前页面，跳转到应用内的某个指定页面(<箭头)
<!-- 
测试账密:15758966164/000000
每次登陆后，想要解除需长按蜻蜓关机键=》系统设置=》小程序容器=》重置小程序，再进入开发者。
新设备或设备恢复出厂设置。机器自动配置=》匹配外接键盘=》设置收银模式=》
在[扫码绑定收款账号]这一步，长按关机键=》设置=》关于本机=》小程序容器=》重置小程序容器=》开发者模式。
 -->

```js
// yuming =》 host
// 设备SN初始化，从结果中获取设备SN码，测试机为[QCF420191109234749](该值贴在设备背面)
// 通过设备SN码、设备类型、版本号、md5值，POST请求，返回第一次初始化的结果。
Request URL: https://vip.whlxsz.com/api/devicepay/face_device_start
Request Method: POST
{"device_id":"QCF420191109234749","device_type":"face_f4","version":"1.1.1","sign":"9491f9046e5c1756a8c863d01f6ed7cc"}
// 返回结果。版本号、sign值和一堆API

// 第二次初始化请求
Request URL: https://vip.whlxsz.com/api/devicepay/face_pay_start
Request Method: POST
{"device_id":"QCF420191109234749","device_type":"face_f4","sign":"7660d4023e80d9385cd79cc24e1d5676"}
// 返回结果 (因为还没有给设备绑定)
{return_code:"FALL",return_msg:"设备不存在",sign:"60dfe8a1bec0e506b03f59b904b17847"}

// 此时，如果使用测试账号登陆，会提示[账户和设备绑定关系不一致]
// 网站:服务商管理后台=》系统设置=》设备列表，可以查看到设备号为[QCF420191109234749]的测试设备，绑定门店为空。
// 网站: 门店管理=》门店列表=》设备管理=》添加/删除设备。可以绑定设备到该账号下。
// 或微信:慧鑫云小程序=》测试账号登陆=》设置=》添加设备=》刷脸设备=》将测试设备SN添加到该账号下。
```

# ============ 以下按照开发时逆序记录开发相关要点 ============ #


# 支付宝问题
- 真机模式下:new Date()返回{}。
```js 暂行方案
// 虽然返回{}，但必须有这一句，才能够使用getDay()等函数
date = new Date(date);
```

## 重新整理流程
- app.js 全局变量定义，onLaunch()中获取设备信息并将其缓存
 <!-- 因为设备初始化执行晚于 index.js加载，所以设备初始化放在index.js中。
      同时，亦为保证PC管理后台变更配置等操作，设备上能够时时同步。
  -->

- index.js onLoad 设备初始化、支付初始化、轮播图、判断是否存有用户信息
- - 设备初始化：返回域名、一些相关API、版本号等数据。
- - 支付初始化：拿到返回的域名及API，返回设备绑定商家的一些信息。
- - 轮播图数组：用于在index.html上待机轮播
- - 是否存在用户信息？不存在。跳转到登入(signin)模块,此处已缓存isv手机和logo

- signin.js
- - 不登入。点击左上角(home)，进入index.js，重走逻辑，再次跳入signin模块
- - 登入。判断是否已设置收银模式。
- - - 未设置收银模式：跳转到设置收银模式页面。
- - - 已设置收银模式：跳转到index.js页面。(因为登入与收银模式非必要关联，逻辑单独处理。)

- cashiermode.js 收银模式
- - 不进行收银模式设置。点击左上角(home)，进入index.js逻辑，显示轮播图。

- index.js 待机轮播状态下，键盘指令及相关处理
- - 设置:code=134。跳转到设置页面
- - 收款:code=131。跳转到`pay`页面，处理支付相关逻辑。

<!-- 暂无后端支持，这部分先搁置。

 付款模式：刷脸/刷码支付、二维码支付、会员支付、花呗分期

将原本的设置=》会员支付(开关)移除，统一在支付处理的地方，罗列以上支付方式，让用户自由选择。
会员支付：获取消费者会员信息，若获取失败，引导消费者注册(储值-消费)
刷脸支付：消费者看向屏幕。
刷码支付：消费者在手机提供收/付款码给设备摄像头。
二维码付：机器出示二维码，消费者扫码。
花呗分期：似乎尚不支持刷脸。

huiyuanzhongxin：设置开启会员支付。
payment：会员支付
membersuccess：会员卡支付成功
hyyue：会员余额

 -->

 # Pay 支付处理
- index页面时点击收款，跳转到本模块。目前为独立收银状态下。
- 显示待支付金额，给出支付选项(缺少后端支持)。
- 跳转到支付宝等待支付页面，可接收(支付宝刷脸/刷码支付、微信扫码支付);
- 支付完成。将结果显示到本模块页面。
- - 刷脸支付：给出领取优惠券/会员卡等功能。
- - 刷码支付：给出广告。(此处似乎可以进行一些其他(广告性质)操作的开发)
- [未做]收银机收银状态下，index页面直接点击`激活收银台`，对接微收银，进行后续处理。


# CSS 规范
- 封装组件使用内部样式
- 非封装组件，尽量使用通用样式
- label+text类型：明文+值


# 设备不存在，原因排查
- 后台管理系统误删设备，具体操作为：
- - 服务商管理后台=》系统配置=》设备列表=》添加/删除设备
- - 唯有经过以上添加步骤，才会在DeviceOem表中有对应设备数据，后续才能使用。

# Index 添加打印相关
- 做完打印设置之后，在Index中添加打印相关设置。

<!-- 原缓存值
打印机开关、打印二维码开关(暂时不打印二维码)、打印联设置(一联二联)
 -->

# 收银机收银模式
- 由收银机发起，在蜻蜓设备上扫码，即支付成功

# 组件化 
- 写法详见 components文件夹下组件(组件html结构可多个同级)
- picker-item：选择器封装

## picker-item 选择器
- 使用场景：指定门店、指定店员、订单状态、简报模式、指定周期。
- 布局：左(label)右(选择器)

## 交易统计区域 trade-statistics
- 使用模块：自定义查询、经营简报。
- 布局：左(label)右(text)

## 交易单列表 order-list
- 使用模块：门店流水、自定义查询。
- 查看详情：附带单机单项，跳转到收款详情页面

## 系统信息组件 system-info
- 使用模块:系统设置、登入系统
- 布局：居中两行(上行LOGO，下行联系方式)

# 会员中心
- 所指为`蜻蜓`会员，目前无客户使用，暂时不做。

# 预授权
- 所指为`酒店`相关，目前无客户使用，暂时不做。

# 打印设置
- 是否开启打印功能
- 打印联设置：一联、二联
- 打印二维码：是否开启，暂时注释。(设备不支持纸质二维码扫码)


# 周期 
- 周期数组格式：2021/03/08 - 2021/03/14，若从当日-注册日，直接使用push，减少排序步骤。
- 当前时间：避免当日之后的无用计算。
- 注册时间：避免从1970年开始算
- 找出传入日期的周一。
- 传入日期的周日 = 周一毫秒值+86400000 * 6

# storereport 经营简报
- 指定门店：全部或选择
- 指定店员：全部或选择
- 简报模式：日报、周报、月报、自定义
- 日报：选择单日，不含时间。
- 周报：选择周区间。制作picker支持的数据格式
- 月报：选择含年月。制作picker支持的数据格式
- 筛选条件：弹层。模式自定义时，大概该弹层
- 数据概览：默认日报模式，查询当日；每次模式选择，都进行查询，每次时间变更，继续查询
- 支付方式统计:支付宝、微信

# 支付密码弹层
- 输入六位密码：六个格子，有值为•，无值为""。
- 安全键盘：随机0-9数字成矩阵(洗牌算法)，末尾固定项[删除键]
- 密码输入逻辑：满六位自动发起请求。

# 安全键盘
- 随机生成0-9，接受按钮点击事件
- 随机排列0-9的图片，退格在末尾
- 数字键盘：勉强可以作为安全键盘，但尽量实现安全键盘。

# PayDetail 收款详情
- 账单明细：含以下原有信息，并考虑添加某些信息
- 退款按钮：点击弹出退款金额。
- 退款金额层：使用input数字键盘需判断小数点，需转换为实际金额形式。
- 退款金额逻辑处理:输入金额合法、金额不能大于全款等。
- 点击确定：显示支付密码弹层。
- 退款逻辑：校验支付密码，匹配成功后，发起退款请求接口，处理返回结果。

<!-- 原页面
打印小票：点击没反应，需连接打印机
 -->


# CustomSearch 自定义查询
- 门店流水=>自定义查询，跳转到该模块。
- 开始时间：my.datePicker中设置的开始及结束无效
- 结束时间：my.datePicker中设置的开始及结束无效
- 指定门店：封装组件(picker-item)
- 指定店员：封装组件(picker-item)
- 订单状态：封装组件(picker-item)
- 交易概览：实收金额、交易金额、交易量、退款金额、退款量、
- 交易列表：每笔交易概览(交易源、交易源明文、门店、创建时间、交易状态、金额)
- 单笔点击：跳转到详情页面()
<!-- 
my.ix.codeScan 单次扫码
原代码相关函数：outtrade()打开弹层、outbind()查询按钮、scanTap()扫码、
 -->


# Storebill 门店流水模块
- picker组件做选择器。指定门店及指定店员改为封装组件
- 页面加载时， 门店和店员默认值为[全部]
- 点击门店选项，在选择器中选择一个门店，或者选择手动加入数组第一项的[全部]。
- 在选择门店后，才会获取店员列表，可以选择店员，或选择手动加入数组第一项的[全部]。
- 页面刷新就查询一次，之后每变更门店或店员，查询一次。
- 列表数据展示方式与自定义查询列表数据展示方式一直(已组件化)
- 自定义查询：跳转到自定义查询页面
- 订单号查询：弹层输入订单号，点击查询=》跳转到收款详情
- 二维码查询：暂未实现。


<!-- 
在index页面使用外接键盘[收款时]，需判断当前是否登入，而后判断是否有收银模式。
设备留在设置页面时，是否允许启动收款相关？即，是否自动跳到index页面？
轮播图:来源服务商管理后台=>广告列表=》添加广告(可以默认所有门店，可以指定单个或多个门店)，前端无需多做实现，使用ad_data属性值即可
 -->

 # Index 
 - 输入金额=》点击收款。页面默认扫码支付，
 - 点击底部`刷脸支付`切换到刷脸支付页面
 - 广告:多图或视频。(目前未做视频广告)
 - 


# Setting 重写程序设置模块
- 外接键盘设置指令，调出程序设置界面
- 添加已完成的`收银模式`、`用户信息`两个模块。
- 用户信息:跳转到用户信息页面(也就是signout模块)
- 收银模式:跳转到设置收银模式页面；
- 门店流水:已完成。
- 经营简报:已完成。
- 会员中心:已移除。改为由发起支付时操作，使用或引导注册会员。
- 预授权:未作。
- 打印设置:已完成设置项。
- 系统设置:该项直接使用my.ix.startApp({ appName: `settings`, })


# CashierMode 重写收银模式模块
- 列出所有收银模式，收银模式缓存只在当前页面设置，其他地方可获取使用
- 收银模式选定，切换到index页面。
- 尚有`固定金额模式`、`客显模式`的特殊实现未作
- 暂时将登出模块搬到index下。
- 登入结果相关数据缓存。
- 登出时，清除登入结果相关缓存。
- 登出时，不清除已设置的收银模式。需要在设置页面中进入收银模式，进行设置。

# SignOut 重写登出模块
- 该模块由键盘`设置`=》设置页面`用户信息`=>登出账号
- 登出前，弹层提醒用户相关事项。
- 账号登出时，清除缓存的`userInfo`对象值，跳转到登入页面。

# SignIn 重写登入模块
- 账号绑定页面：账密输入、密码明文查看、底部信息(logo及技术支持电话)、登入按钮
- 登入事件:接口及接口返回结果。
- 登陆按钮事件冷却：点击即禁用，在事件返回结果后，重新打开。
- 原登入模块有`打印`相关，重写版暂未实现。


